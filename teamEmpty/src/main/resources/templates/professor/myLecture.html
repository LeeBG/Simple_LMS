<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<!-- 전체 강의 리스트 -->
<head th:insert="layout/header :: head"></head>
<body>
<header th:insert="layout/header :: header"></header>
<main>
    <div style="width: 70%">
        <form id="MyLectureSearchForm">
            <label>강의명 :
                <input type="text" name="name">
            </label>
            <label>학과 선택 :
                <select name="major">
                    <option th:text="'전공 선택'" value="">전공 선택</option>
                    <option th:each="major : ${MajorList}" th:value="${major}" th:text="${major}"></option>
                </select>
            </label>
            <label>강의 타입 :
                <select name="type" th:default="'강의 형태'">
                    <option th:text="'강의 형태'" value=""></option>
                    <option th:text="'전공 필수'" th:value="전공필수"></option>
                    <option th:text="'전공 선택'" th:value="전공선택"></option>
                    <option th:text="'필수 교양'" th:value="필수교양"></option>
                    <option th:text="'선택 교양'" th:value="선택교양"></option>
                </select>
            </label>
            <label>기간 :
                <select name="year">
                    <option th:text="년도" value=""></option>
                    <option th:each="year : ${YearList}" th:value="${year}" th:text="${year} + '년'"></option>
                </select>
                <select name="semester">
                    <option th:text="학기" value=""></option>
                    <option th:text="1학기" th:value="1"></option>
                    <option th:text="2학기" th:value="2"></option>
                </select>
            </label>
            <label>학년 :
                <select name="grade">
                    <option th:text="학년" value=""></option>
                    <option th:each="grade : ${GradeList}" th:value="${grade}" th:text="${grade} + '학년'"></option>
                </select>
            </label>
            <button type="button" onclick="searchLectures()">검색</button>
            <input type="reset" value="초기화" onclick="resetAndSearch()">
        </form>
    </div>
    <table class="table table-bordered">
        <thead>
        <tr>
            <td>
                <div th:text="강의명">제목열1</div>
            </td>
            <td>
                <div th:text="전공">제목열4</div>
            </td>
            <td>
                <div th:text="'강의 타입'">제목열5</div>
            </td>
            <td>
                <div th:text="'수강 학점'">제목열6</div>
            </td>
            <td>
                <div th:text="'강의 시간'">x요일 xx:xx ~ xx:xx, x요일 xx:xx ~ xx:xx</div>
            </td>
            <td>
                <div th:text="'수강 인원'">현재 수강자 수 / 최대 인원 수</div>
            </td>
            <td>
                <div th:text="'강의 학기'">xxxx년 x학기</div>
            </td>
            <td>
                <div th:text="학년">제목열1</div>
            </td>
            <td>
                <div th:text="강의실">제목열1</div>
            </td>
            <td>
                <div th:text="'강의 계획서'">제목열1</div>
            </td>
        </tr>
        </thead>
        <tbody id="MylectureTableBody">
        <tr th:each="row : ${MyList}">
            <td>
                <div th:text="${row.name}"></div>
            </td>
            <td>
                <div th:text="${row.major}"></div>
            </td>
            <td>
                <div th:text="${row.type}"></div>
            </td>
            <td>
                <div th:text="${row.credit}"></div>
            </td>
            <td>
                <div th:text="${row.day}"></div>
            </td>
            <td>
                <div th:text="${row.currentCount} + '/' + ${row.maxCount}"></div>
            </td>
            <td>
                <div th:text="${row.semester}"></div>
            </td>
            <td>
                <div th:text="${row.grade} + '학년'"></div>
            </td>
            <td>
                <div th:text="${row.location} + ' ' + ${row.lectureRoom}"></div>
            </td>
            <td>
                <div th:if="${row.plan != null}" class="planExist"><span>등록됨</span></div>
                <div th:if="${row.plan == null}" class="planExist">
                    <span class="upload-btn" onclick="openFileUploadDialog(this)">미등록</span>
                    <input type="hidden" class="lectureIdx" th:value="${row.idx}">
                    <input type="file" class="file-input" onchange="handleFileUpload(this)">
                </div>
            </td>
        </tr>
        </tbody>
    </table>

    <script>
        function searchLectures() {
            var form = document.getElementById("MyLectureSearchForm");

            // form 엘리먼트가 올바르게 식별되었는지 확인
            if (!form) {
                console.error('Form 엘리먼트를 찾을 수 없습니다.');
                return;
            }

            var formData = new FormData(form);

            fetch('/professor/MyLecture/data', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(Object.fromEntries(formData))
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('네트워크 응답이 정상이 아닙니다');
                    }
                    return response.json();
                })
                .then(data => {
                    // 서버 응답을 받은 후에 테이블 업데이트
                    updateTableBody(data);
                })
                .catch(error => {
                    console.error('에러:', error);
                });
        }

        function updateTableBody(data) {
            var tbody = document.getElementById("MylectureTableBody");

            // 기존 행 삭제 (기존 데이터를 모두 지우고 새로운 데이터를 추가할 것이므로)
            tbody.innerHTML = "";

            // 서버 응답을 이용하여 여러 행 추가
            data.forEach(item => {
                var tr = document.createElement("tr");

                // 각 열에 대한 데이터 추가
                appendTd(tr, item.name);
                appendTd(tr, item.intro);
                appendTd(tr, item.major);
                appendTd(tr, item.type);
                appendTd(tr, item.credit);
                appendTd(tr, item.day);
                appendTd(tr, `${item.currentCount}/${item.maxCount}`);
                appendTd(tr, item.semester);
                appendTd(tr, `${item.grade}학년`);
                appendTd(tr, `${item.location} ${item.lectureRoom}`);

                tbody.appendChild(tr);
            });
        }

        // 특정 데이터를 <td>에 추가하는 함수
        function appendTd(parent, text) {
            var td = document.createElement("td");
            var div = document.createElement("div");
            div.textContent = text;
            td.appendChild(div);
            parent.appendChild(td);
        }

        function resetAndSearch() {
            document.getElementById("MyLectureSearchForm").reset();
            searchLectures();
        }

        // 파일 업로드 창 열기
        function openFileUploadDialog(btnElement) {
            var fileInput = btnElement.nextElementSibling.nextElementSibling;
            fileInput.click();
        }

        async function handleFileUpload(inputElement) {
            var fileInput = inputElement;
            var planStatusElement = fileInput.previousElementSibling.previousElementSibling;
            var lectureIdxElement = fileInput.previousElementSibling;

            var lectureIdx = lectureIdxElement.value;

            // 선택된 파일이 있을 경우에만 처리
            if (fileInput.files.length > 0) {
                var selectedFile = fileInput.files[0];

                var formData = new FormData();
                formData.append('plan', selectedFile);
                formData.append('lectureIdx', lectureIdx);

                try {
                    const response = await fetch('/professor/planUpload', {
                        method: 'PUT',
                        body: formData
                    });

                    const data = await response.text();

                    if (data !== undefined) {
                        if (parseInt(data) === 0) {
                            console.error('업로드 실패');
                        } else {
                            console.log('업로드 성공');
                            // 업로드 성공 시 UI를 갱신 (미등록 → 등록됨)
                            planStatusElement.innerHTML = '<span>등록됨</span>';
                            planStatusElement.classList.remove('upload-btn'); // span 태그를 비활성화하기 위해 클래스 제거
                            planStatusElement.removeAttribute('onclick'); // 클릭 이벤트 제거
                            fileInput.disabled = true; // 파일 업로드 input을 비활성화
                        }
                    } else {
                        console.error('잘못된 응답 형식');
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            }
        }
    </script>
</main>
<footer th:insert="layout/header :: footer"></footer>
</body>
</html>