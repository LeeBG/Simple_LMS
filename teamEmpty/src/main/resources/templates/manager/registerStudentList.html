<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:insert="layout/header :: head">
    <style>
        .not-found {
            color: red;
            font-weight: bold;
        }
    </style>
</head>


<body>
<header th:insert="layout/header :: header"> </header>
<div class="container mt-3">
    <h2>학생 등록 명단</h2> <p th:text="${students}"></p>
    <p th:text="${message}"></p>
    <hr>
    <form method="post" action="/manager/addStudentList">
        <table class="table table-bordered">
            <tr>
                <th>번호</th>
                <th>학번</th>
                <th>이름</th>
                <th>주민번호</th>
                <th>연락처</th>
                <th>주소</th>
                <th>이메일</th>
                <th>입학일</th>
                <th>학년</th>
                <th>학과번호</th>
                <th>지도교수번호</th>
                <th>수정</th>
            </tr>
            <tr th:each="student : ${studentList}">
                <td contenteditable="true" data-field="idx" th:text="${student.idx}"></td>
                <td contenteditable="true" data-field="student_num" th:text="${student.student_num}"></td>
                <td contenteditable="true" data-field="name" th:text="${student.name}"></td>
                <td contenteditable="true" data-field="security" th:text="${#strings.substring(student.security, 0, 6)} + '-' + ${#strings.substring(student.security, 6)}"></td>
                <td contenteditable="true" data-field="pnum" th:text="${#strings.substring(student.pnum,0,3)}+'-'+${#strings.substring(student.pnum,3,7)}+'-'+${#strings.substring(student.pnum,7)}"></td>
                <td contenteditable="true" data-field="address" th:text="${student.address}"></td>
                <td contenteditable="true" data-field="email" th:text="${student.email}"></td>
                <td contenteditable="true" data-field="entranceDate" th:text="${student.entranceDate}"></td>
                <td contenteditable="true" data-field="student_grade" th:text="${student.student_grade}"></td>
                <td contenteditable="true" data-field="major" th:text="${student.major}"></td>
                <td contenteditable="true" data-field="professor" th:text="${student.professor}"></td>
            </tr>
        </table>
        <button id="saveBtn" type="button" onclick="saveStudentList()">학생 전체 등록</button>
    </form>

</div>
<footer th:insert="layout/header :: footer"></footer>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<script>
    document.querySelectorAll('td[data-field="major"], td[data-field="professor"]').forEach(td => {
        if (td.innerText.includes('정보없음')) {
            td.classList.add('not-found');
        }
    });


    function saveStudentList() {
        const updatedStudents = [];

        const tableRows = document.querySelectorAll('table tr');

        tableRows.forEach((row, index) => {
            if (index > 0) { // Header row를 제외한 테이블의 첫 번째 row부터 시작
                const student = {
                    idx: row.querySelector('td[data-field="idx"]').innerText,
                    student_num: row.querySelector('td[data-field="student_num"]').innerText,
                    name: row.querySelector('td[data-field="name"]').innerText,
                    security: row.querySelector('td[data-field="security"]').innerText,
                    pnum: row.querySelector('td[data-field="pnum"]').innerText,
                    address: row.querySelector('td[data-field="address"]').innerText,
                    email: row.querySelector('td[data-field="email"]').innerText,
                    entranceDate: row.querySelector('td[data-field="entranceDate"]').innerText,
                    student_grade: row.querySelector('td[data-field="student_grade"]').innerText,
                    major: row.querySelector('td[data-field="major"]').innerText,
                    professor: row.querySelector('td[data-field="professor"]').innerText
                };
                updatedStudents.push(student);
            }
        });

        console.log('수정된 학생 정보:', updatedStudents);

        // 사용자에게 수정 내용 확인 다이얼로그 표시
        if (confirm('수정된 내용을 저장하시겠습니까?')) {
            fetch('/manager/addStudentList', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updatedStudents)
            })
                .then(data => {
                    console.log('학생 정보 업데이트 완료:', data);
                    // 성공적으로 업데이트되었을 때 수행할 작업 추가
                    alert('학생 정보가 업데이트되었습니다.');
                })
                .catch(error => {
                    console.error('학생 정보 업데이트 실패:', error);
                    // 실패 시 처리
                    alert('학생 정보 업데이트에 실패했습니다.');
                });
        }
    }

</script>

</body>
</html>